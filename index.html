<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>TSAMACO</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    /* Gaya CSS seperti sebelumnya */
  </style>
</head>
<body>
  <div class="wrap">
    <div class="head">
      <div class="logo">S</div>
      <h1>STAMACO</h1>
      <div class="sub">Seleksi Persiapan Tsanawiyah Ma'arif Competition MTs Amtsilati</div>
    </div>

    <div class="search">
      <input id="q" placeholder="Ketik nama mapel (contoh: matematika, ipa, bahasa arab...)">
    </div>

    <div id="results" class="results" aria-live="polite"></div>
    <footer>@pacegondes <strong>2025</strong>. pacegondes.blogspot.com</footer>
  </div>

  <script>
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vT1s3KCGJWMcqWQkTppTXiuZMxxFUPJVLIxttNtOFRg2tzDT7kDeWxOyVofc8Fa7-PAQj8IiLD_S1Sw/pub?output=csv";
    let all = [];

    function parseCSV(text) {
      const rows = text.split(/\r?\n/).filter(r => r.trim() !== "");
      if (!rows.length) return [];
      const header = rows.shift().split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(h => h.trim().toLowerCase());
      const iIcon = header.indexOf("ikon");
      const iNama = header.indexOf("nama file");
      const iLink = header.indexOf("link file");
      return rows.map(line => {
        const cols = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(c => c.replace(/^"|"$/g, '').trim());
        return { ikon: (iIcon > -1 ? cols[iIcon] : "") || "", nama: cols[iNama] || cols[0] || "Untitled", link: cols[iLink] || cols[cols.length - 1] || "#" };
      });
    }

    const MAPEL_ICONS = [
      { k: ['al-qur', 'qur', 'alqur', 'alquran', 'quran'], icon: '📖' },
      { k: ['akidah', 'akhlak', 'aqidah'], icon: '🕌' },
      { k: ['fikih', 'fiqih'], icon: '📜' },
      { k: ['ski', 'sejarah kebudayaan islam'], icon: '🕌' },
      { k: ['bahasa arab', 'b.arab'], icon: '👳‍♂️' },
      { k: ['bahasa indonesia', 'bindo', 'indonesia'], icon: '📝' },
      { k: ['mtk', 'matematika'], icon: '➗' },
      { k: ['bahasa inggris', 'bing', 'english'], icon: '🇬🇧' },
      { k: ['ipa', 'sains', 'ilmiah', 'science'], icon: '🔬' },
      { k: ['ips', 'social', 'sejarah'], icon: '🌍' },
      { k: ['ppkn', 'pendidikan pancasila dan kewarganegaraan'], icon: '🇮🇩' },
      { k: ['ke-nu-an', 'nu', 'kenuan'], icon: '🌿🕌' }
    ];

    function detectIcon(name, csvIcon) {
      if (csvIcon && csvIcon.trim()) return csvIcon.trim();
      const lower = name.toLowerCase();
      for (const m of MAPEL_ICONS) for (const k of m.k) if (lower.includes(k)) return m.icon;
      const pool = ['🏆', '🎯', '📚', '✍️', '🎓', '🔖', '📌', '🧠', '🔎', '⭐'];
      return pool[Math.floor(Math.random() * pool.length)];
    }

    function highlight(text, q) {
      if (!q) return escapeHtml(text);
      const esc = q.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
      const re = new RegExp(esc, 'ig');
      return escapeHtml(text).replace(re, m => `<mark class="hi">${m}</mark>`);
    }

    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' })[c]);
    }

    function escapeAttr(s) {
      return s ? s.replace(/"/g, '&quot;') : '';
    }

    function render(items, q = "") {
      const cont = document.getElementById('results');
      cont.innerHTML = "";
      if (!items.length) {
        cont.innerHTML = '<div class="empty">Tidak ada soal yang cocok.</div>';
        return;
      }
      items.forEach(it => {
        const icon = detectIcon(it.nama, it.ikon);
        const card = document.createElement('article');
        card.className = 'card';
        card.innerHTML = `
          <div class="top">
            <div class="symbol">${icon}</div>
            <div class="meta">
              <div class="mapel">${highlight(it.nama, q)}</div>
            </div>
          </div>
          <div class="actions">
            <a class="btn open" href="${escapeAttr(it.link)}" target="_blank" rel="noopener">Buka Soal ↗</a>
          </div>
        `;
        cont.appendChild(card);
      });
    }

    async function load() {
      try {
        const res = await fetch(CSV_URL);
        if (!res.ok) throw new Error('Fetch error: ' + res.status);
        const text = await res.text();
        all = parseCSV(text);
        all.sort((a, b) => a.nama.localeCompare(b.nama));
        render(all);
      } catch (err) {
        document.getElementById('results').innerHTML = `<div class="empty">Gagal mengambil data: ${escapeHtml(err.message)}</div>`;
        console.error(err);
      }
    }

    document.getElementById('q').addEventListener('input', () => {
      const q = document.getElementById('q').value.trim().toLowerCase();
      render(all.filter(i => i.nama.toLowerCase().includes(q)), q);
    });

    load();
  </script>
</body>
</html>
